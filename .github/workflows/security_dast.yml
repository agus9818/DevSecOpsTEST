name: DevSecOps - Dynamic Security Scan (DAST)

on:
  pull_request:
    branches: [ main ]

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Construir la Imagen de la Aplicación Flask
      - name: Build Flask App Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false # Solo construir, no subir a Docker Hub
          tags: flask-app-test:latest

      # 2. Levantar el Contenedor de la Aplicación en Background
      - name: Start Flask App Container
        run: |
          # Levantar el contenedor en background y mapear el puerto 5000
          docker run -d --rm --name flask-app-container -p 5000:5000 flask-app-test:latest
          echo "Waiting 10 seconds for app to start..."
          sleep 10

      # 3. Ejecutar el Escaneo DAST con OWASP ZAP
      - name: ZAP Scan (DAST)
        uses: zaproxy/action-baseline@v0.14.0
        with:
          # El objetivo es localhost:5000 porque el puerto fue mapeado
          target: 'http://localhost:5000' 
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable' 
          fail_action: true
          exclude_rules_file: '.zap_exlude_rules.tsv'
          allow_issue_writing: false

      # 4. Detener el Contenedor (Limpieza)
      - name: Stop Flask App Container
        if: always()
        run: docker stop flask-app-container