name: DevSecOps - Dynamic Security Scan (DAST)

on:
  pull_request:
    branches: [ main ]

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    # Define la aplicaciÃ³n Flask como un servicio Docker
    services:
      flask_app:
        image: flask-app-test:latest # Nombre temporal para la imagen
        # Construye el Dockerfile directamente en el runner
        options: >
          --build-arg FLASK_ENV=testing
          --build-context context=.
        ports:
          - 5000:5000 # Mapeo de puertos

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Ejecutar el Escaneo DAST con OWASP ZAP
      - name: ZAP Scan (DAST)
        uses: zaproxy/action-baseline@v0.14.0
        with:
          # El objetivo es el nombre del servicio, NO localhost
          target: 'http://flask_app:5000' 
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable' 
          fail_action: true
          allow_issue_writing: false